#!/usr/bin/expect

set timeout 30
set monitor_host "192.168.50.212"
set server_host "192.168.50.210"
set client_host "192.168.50.211"

# Log file setup
log_file -a "snmp_test_results.log"
send_log "\n=== Starting SNMP Basic Validation Tests ===\n"
send_log "[exec date]\n"

proc test_snmp_connectivity {host} {
    global timeout
    send_log "\nTesting SNMP connectivity to $host...\n"
    
    spawn snmpwalk -v2c -c public $host system
    expect {
        "system.sysDescr.0" {
            send_log "✓ SNMP connectivity successful to $host\n"
            return 1
        }
        timeout {
            send_log "✗ SNMP connectivity timeout to $host\n"
            return 0
        }
        eof {
            send_log "✗ SNMP connectivity failed to $host\n"
            return 0
        }
    }
}

proc verify_metric {host metric_oid expected_pattern} {
    global timeout
    send_log "\nVerifying metric $metric_oid on $host...\n"
    
    spawn snmpget -v2c -c public $host $metric_oid
    expect {
        -re $expected_pattern {
            send_log "✓ Metric validation successful\n"
            return 1
        }
        timeout {
            send_log "✗ Metric validation timeout\n"
            return 0
        }
        eof {
            send_log "✗ Metric validation failed\n"
            return 0
        }
    }
}

# Test 1: Basic Connectivity
set test_results(connectivity) 1
foreach host [list $monitor_host $server_host $client_host] {
    if {![test_snmp_connectivity $host]} {
        set test_results(connectivity) 0
    }
}

# Test 2: Throughput Metrics
set throughput_oid ".1.3.6.1.4.1.8072.1.3.2.3.1.2.19.115.115.115.111.110.101.99.116.111.114.45.116.104.114.111.117.103.104.112.117.116.1.0"
set test_results(throughput) [verify_metric $monitor_host $throughput_oid {[0-9]+:[0-9]+}]

# Test 3: Connection Metrics
set connections_oid ".1.3.6.1.4.1.8072.1.3.2.3.1.2.21.115.115.115.111.110.101.99.116.111.114.45.99.111.110.110.101.99.116.105.111.110.115.1.0"
set test_results(connections) [verify_metric $monitor_host $connections_oid {[0-9]+}]

# Test 4: Latency Metrics
set latency_oid ".1.3.6.1.4.1.8072.1.3.2.3.1.2.17.115.115.115.111.110.101.99.116.111.114.45.108.97.116.101.110.99.121.1.0"
set test_results(latency) [verify_metric $monitor_host $latency_oid {[0-9.]+}]

# Generate Test Summary
send_log "\n=== Test Results Summary ===\n"
foreach {test result} [array get test_results] {
    if {$result} {
        send_log "✓ $test: PASS\n"
    } else {
        send_log "✗ $test: FAIL\n"
    }
}

# Calculate overall test result
set total_tests [array size test_results]
set passed_tests 0
foreach {test result} [array get test_results] {
    if {$result} {
        incr passed_tests
    }
}

send_log "\nPassed $passed_tests out of $total_tests tests\n"
send_log "Test completion time: [exec date]\n"

# Exit with appropriate status
if {$passed_tests == $total_tests} {
    exit 0
} else {
    exit 1
}
