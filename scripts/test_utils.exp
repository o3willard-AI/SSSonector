#!/usr/bin/expect
# Common test utilities

proc log_test_result {test_name result message} {
    send_log "\n=== $test_name ===\n"
    send_log "Result: [expr {$result ? "PASS" : "FAIL"}]\n"
    send_log "Details: $message\n"
    return $result
}

proc setup_test_environment {} {
    global monitor_host server_host client_host
    set timeout 30
    
    # Close any existing log file
    catch {log_file}
}

proc cleanup_test_environment {} {
    global monitor_host
    
    # Reset SNMP configuration
    spawn ssh $monitor_host "sudo systemctl restart snmpd"
    expect {
        "password for sblanken:" {
            send "101abn\r"
            exp_continue
        }
        timeout {
            send_log "Timeout waiting for SNMP restart\n"
        }
    }
    
    # Clean test data
    spawn ssh $monitor_host "rm -f /tmp/test_*.dat"
    expect {
        "password for sblanken:" {
            send "101abn\r"
            exp_continue
        }
        timeout {
            send_log "Timeout waiting for cleanup\n"
        }
    }
    
    # Close log file
    catch {log_file}
}
