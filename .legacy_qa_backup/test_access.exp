#!/usr/bin/expect -f

# Test SSH and sudo access for each VM
set vms {
    {"Server" "192.168.50.210"}
    {"Client" "192.168.50.211"}
    {"SNMP Server" "192.168.50.212"}
}

foreach vm $vms {
    set name [lindex $vm 0]
    set ip [lindex $vm 1]
    set username "sblanken"

    puts "\nTesting access to $name ($ip)..."

    # Test SSH key authentication and sudo access
    spawn ssh -i /home/sblanken/.ssh/qa_key $username@$ip "echo 'SSH access successful'; sudo -n echo 'Sudo access successful'"

    expect {
        "continue connecting (yes/no" {
            send "yes\r"
            exp_continue
        }
        "password:" {
            puts "❌ SSH key authentication failed on $name"
            exit 1
        }
        "sudo: no tty present" {
            puts "❌ Sudo access failed on $name"
            exit 1
        }
        "SSH access successful" {
            puts "✅ SSH key authentication working on $name"
            exp_continue
        }
        "Sudo access successful" {
            puts "✅ Passwordless sudo working on $name"
        }
        timeout {
            puts "❌ Connection timed out for $name"
            exit 1
        }
        eof
    }
}

puts "\n✅ Access verification complete - all systems accessible"
exit 0
