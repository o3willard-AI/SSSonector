#!/usr/bin/expect -f

set timeout 300
set password "101abn"

# Test configuration
set server_ip "192.168.50.210"
set client_ip "192.168.50.211"
set monitor_ip "192.168.50.212"
set community "public"
set enterprise_oid ".1.3.6.1.4.1.54321"

proc expect_prompt {} {
    expect {
        "password for sblanken:" {
            send "$::password\r"
            exp_continue
        }
        -re {[#\$] $}
    }
}

# Connect to server VM to run SSSonector server
spawn ssh -i /home/sblanken/.ssh/qa_key sblanken@$server_ip
expect {
    "continue connecting (yes/no" {
        send "yes\r"
        exp_continue
    }
    -re {[#\$] $} {
        puts "\nStarting SSSonector server with SNMP enabled..."
        send "cd /usr/local/bin\r"
        expect_prompt
        send "sudo ./sssonector server -c /etc/sssonector/server.yaml --snmp-enabled --snmp-port 161 --snmp-community public &\r"
        expect_prompt
        
        # Wait for server to start
        send "sleep 5\r"
        expect_prompt
        
        # Verify SNMP agent is listening
        send "sudo netstat -tulpn | grep :161\r"
        expect_prompt
        
        # Test basic SNMP GET
        puts "\nTesting SNMP GET operations..."
        send "snmpget -v2c -c $community localhost $enterprise_oid.1.6\r"
        expect_prompt
        
        # Test SNMP WALK
        puts "\nTesting SNMP WALK..."
        send "snmpwalk -v2c -c $community localhost $enterprise_oid\r"
        expect_prompt
        
        # Test invalid community
        puts "\nTesting invalid community string..."
        send "snmpget -v2c -c invalid localhost $enterprise_oid.1.6\r"
        expect_prompt
        
        # Test unknown OID
        puts "\nTesting unknown OID..."
        send "snmpget -v2c -c $community localhost $enterprise_oid.999\r"
        expect_prompt
    }
}

# Connect to client VM to run SSSonector client
spawn ssh -i /home/sblanken/.ssh/qa_key sblanken@$client_ip
expect {
    "continue connecting (yes/no" {
        send "yes\r"
        exp_continue
    }
    -re {[#\$] $} {
        puts "\nStarting SSSonector client..."
        send "cd /usr/local/bin\r"
        expect_prompt
        send "sudo ./sssonector client -c /etc/sssonector/client.yaml &\r"
        expect_prompt
        
        # Wait for client to connect
        send "sleep 5\r"
        expect_prompt
        
        # Generate some traffic
        puts "\nGenerating test traffic..."
        send "dd if=/dev/urandom of=/dev/null bs=1M count=100\r"
        expect_prompt
        
        # Check metrics after traffic
        puts "\nVerifying metrics after traffic..."
        send "snmpget -v2c -c $community $server_ip $enterprise_oid.1.1 $enterprise_oid.1.2\r"
        expect_prompt
    }
}

# Connect to monitor VM to verify metrics from external perspective
spawn ssh -i /home/sblanken/.ssh/qa_key sblanken@$monitor_ip
expect {
    "continue connecting (yes/no" {
        send "yes\r"
        exp_continue
    }
    -re {[#\$] $} {
        puts "\nVerifying metrics from monitor VM..."
        
        # Check all metrics
        send "snmpwalk -v2c -c $community $server_ip $enterprise_oid\r"
        expect_prompt
        
        # Compare with ntopng stats
        puts "\nComparing with ntopng statistics..."
        send "curl -s http://localhost:3000/lua/rest/get/interface/stats.lua?name=enp0s3 | python3 -m json.tool\r"
        expect_prompt
    }
}

puts "\nSNMP testing complete"
exit 0
