#!/usr/bin/expect -f

set timeout 30
set password "101abn"

# Function to configure vsftpd on a system
proc configure_system {host} {
    global password
    
    puts "\n=== Configuring vsftpd on: $host ==="
    spawn ssh sblanken@$host "echo '$password' | sudo -S bash -c 'cat > /etc/vsftpd.conf << \"EOL\"
# vsftpd configuration for rate limit testing
listen=YES
listen_ipv6=NO
anonymous_enable=NO
local_enable=YES
write_enable=YES
local_umask=022
dirmessage_enable=YES
use_localtime=YES
xferlog_enable=YES
connect_from_port_20=YES
xferlog_file=/var/log/vsftpd.log
xferlog_std_format=YES
chroot_local_user=YES
allow_writeable_chroot=YES
pam_service_name=vsftpd
pasv_enable=YES
pasv_min_port=40000
pasv_max_port=40100
user_sub_token=\$USER
local_root=/home/\$USER
EOL

# Restart vsftpd service
systemctl restart vsftpd

# Check service status
echo === VSFTPD STATUS ===
systemctl status vsftpd'"

    expect {
        "password:" {
            send "$password\r"
            exp_continue
        }
        timeout {
            puts "\n❌ Operation timed out"
            exit 1
        }
        eof {
            puts "\n✅ Configuration complete"
        }
    }
}

# Configure both systems
configure_system "192.168.50.210"
configure_system "192.168.50.211"
