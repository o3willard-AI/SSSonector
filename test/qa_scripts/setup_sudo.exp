#!/usr/bin/expect -f

# Load VM credentials from JSON file
set qa_env [exec cat qa_environment.json]
set qa_vms [exec echo $qa_env | jq -r ".qa_vms\[\]"]

# Sudo configuration template
set sudoers_config "# Allow passwordless sudo for QA automation
$env(USER) ALL=(ALL) NOPASSWD: ALL"

foreach vm $qa_vms {
    set name [exec echo $vm | jq -r ".name"]
    set ip [exec echo $vm | jq -r ".ip"]
    set username [exec echo $vm | jq -r ".username"]
    set password [exec echo $vm | jq -r ".password"]
    set sudo_password [exec echo $vm | jq -r ".sudo_password"]

    puts "\nConfiguring sudo access on $name ($ip)..."

    # Create temporary sudoers file
    set tmp_file [open "qa_sudoers" w]
    puts $tmp_file $sudoers_config
    close $tmp_file

    # Copy sudoers file to remote host
    spawn scp -i ~/.ssh/qa_key qa_sudoers $username@$ip:/tmp/
    expect eof

    # Install sudoers file
    spawn ssh -i ~/.ssh/qa_key $username@$ip

    expect {
        "$" {
            send "echo '$sudo_password' | sudo -S chown root:root /tmp/qa_sudoers\r"
            expect "$"
            send "echo '$sudo_password' | sudo -S chmod 440 /tmp/qa_sudoers\r"
            expect "$"
            send "echo '$sudo_password' | sudo -S mv /tmp/qa_sudoers /etc/sudoers.d/99-qa-automation\r"
            expect "$"
            
            # Verify sudo access
            send "sudo -n true\r"
            expect {
                "password for" {
                    puts "❌ Passwordless sudo setup failed on $name"
                    exit 1
                }
                "$" {
                    puts "✅ Successfully configured passwordless sudo on $name"
                }
            }
            send "exit\r"
        }
    }
}

# Clean up temporary file
exec rm -f qa_sudoers

puts "\n✅ Sudo access configured on all VMs"
exit 0
