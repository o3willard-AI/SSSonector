#!/usr/bin/expect -f

set timeout 30
set password "101abn"

puts "=== Fixing SNMP Script ==="
spawn ssh sblanken@192.168.50.212 "echo '$password' | sudo -S bash -c 'cat > /usr/local/bin/sssonector-snmp << \"EOL\"
#!/bin/bash

OID=\"\$1\"
TYPE=\"\$2\"

# Function to format output for SNMP
format_output() {
    local value=\$1
    if [ \"\$TYPE\" = \"-n\" ]; then
        echo \"INTEGER \$value\"
    else
        echo \"STRING \$value\"
    fi
}

case \"\$OID\" in
    .1.3.6.1.4.1.54321.1.1) # Bytes In
        value=\$(netstat -i | grep enp0s3 | awk \"{print \\\$3}\")
        format_output \"\$value\"
        ;;
    .1.3.6.1.4.1.54321.1.2) # Bytes Out
        value=\$(netstat -i | grep enp0s3 | awk \"{print \\\$7}\")
        format_output \"\$value\"
        ;;
    .1.3.6.1.4.1.54321.1.3) # Active Connections
        value=\$(netstat -an | grep ESTABLISHED | wc -l)
        format_output \"\$value\"
        ;;
    .1.3.6.1.4.1.54321.1.4) # CPU Usage
        value=\$(top -bn1 | grep \"Cpu(s)\" | awk \"{print \\\$2}\" | cut -d. -f1)
        format_output \"\$value\"
        ;;
    .1.3.6.1.4.1.54321.1.5) # Memory Usage
        value=\$(free | grep Mem | awk \"{printf \\\"%d\\\", \\\$3/\\\$2 * 100}\")
        format_output \"\$value\"
        ;;
    *) # Unknown OID
        echo \"No such object available on this agent at this OID\"
        exit 1
        ;;
esac
EOL

chmod +x /usr/local/bin/sssonector-snmp

echo === RESTARTING SNMPD ===
systemctl restart snmpd

echo === TESTING SCRIPT ===
/usr/local/bin/sssonector-snmp .1.3.6.1.4.1.54321.1.1 -n'"

expect {
    "password:" {
        send "$password\r"
        exp_continue
    }
    timeout {
        puts "\n❌ Operation timed out"
        exit 1
    }
    eof {
        puts "\n✅ Operation complete"
        exit 0
    }
}
