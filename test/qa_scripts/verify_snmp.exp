#!/usr/bin/expect -f

set ip "192.168.50.212"
set username "sblanken"

puts "\nVerifying SNMP and ntopng setup on SNMP Server ($ip)..."

spawn ssh -i /home/sblanken/.ssh/qa_key $username@$ip

expect {
    "continue connecting (yes/no" {
        send "yes\r"
        exp_continue
    }
    "$" {
        # Check if ntopng is running
        puts "\nChecking ntopng status..."
        send "sudo systemctl status ntopng | grep Active\r"
        expect {
            "Active: active (running)" {
                puts "✅ ntopng is running"
            }
            default {
                puts "❌ ntopng is not running"
                exit 1
            }
        }
        expect "$"
        
        # Check if SNMP daemon is running
        puts "\nChecking SNMP daemon status..."
        send "sudo systemctl status snmpd | grep Active\r"
        expect {
            "Active: active (running)" {
                puts "✅ SNMP daemon is running"
            }
            default {
                puts "❌ SNMP daemon is not running"
                exit 1
            }
        }
        expect "$"
        
        # Test SNMP connectivity
        puts "\nTesting SNMP connectivity..."
        send "snmpwalk -v2c -c public localhost system\r"
        expect {
            "End of MIB" {
                puts "✅ SNMP walk successful"
            }
            "Timeout" {
                puts "❌ SNMP walk failed - timeout"
                exit 1
            }
            "Unknown Object Identifier" {
                puts "❌ SNMP walk failed - access denied"
                exit 1
            }
        }
        expect "$"
        
        # Check ntopng web interface
        puts "\nChecking ntopng web interface..."
        send "curl -s -o /dev/null -w '%{http_code}' http://localhost:3000\r"
        expect {
            "200" {
                puts "✅ ntopng web interface is accessible"
            }
            default {
                puts "❌ ntopng web interface is not accessible"
                exit 1
            }
        }
        expect "$"
        
        # Check network interface monitoring
        puts "\nChecking network interface monitoring..."
        send "ntopng --version\r"
        expect "$"
        
        puts "\nVerification complete"
        send "exit\r"
    }
}
expect eof

puts "\nAll checks completed. SNMP Server is ready for testing."
exit 0
