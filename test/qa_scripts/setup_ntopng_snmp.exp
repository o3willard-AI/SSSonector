#!/usr/bin/expect -f

set timeout 10
set password "101abn"

puts "=== Setting up NTOPNG SNMP Integration ==="
spawn ssh sblanken@192.168.50.212 "echo '$password' | sudo -S bash -c 'cat > /etc/snmp/snmpd.conf.d/ntopng.conf << \"EOL\"
# NTOPNG Integration for SSSonector Enterprise MIB
# Base OID: .1.3.6.1.4.1.54321

# Define pass-through for ntopng metrics
pass .1.3.6.1.4.1.54321.1 /usr/local/bin/ntopng-snmp
pass .1.3.6.1.4.1.54321.2 /usr/local/bin/ntopng-snmp-stats

# Create ntopng SNMP script
cat > /usr/local/bin/ntopng-snmp << \"SCRIPT\"
#!/bin/bash
# SNMP pass-through script for ntopng metrics

NTOPNG_URL=\"http://localhost:3000\"
COMMUNITY=\"public\"
OID=\"\$1\"
TYPE=\"\$2\"

case \"\$OID\" in
  .1.3.6.1.4.1.54321.1.1) # Bandwidth In
    curl -s \"\$NTOPNG_URL/lua/rest/get/interface/stats\" | jq -r .bytesRcvd
    ;;
  .1.3.6.1.4.1.54321.1.2) # Bandwidth Out
    curl -s \"\$NTOPNG_URL/lua/rest/get/interface/stats\" | jq -r .bytesSent
    ;;
  .1.3.6.1.4.1.54321.1.3) # Active Flows
    curl -s \"\$NTOPNG_URL/lua/rest/get/interface/stats\" | jq -r .numFlows
    ;;
  .1.3.6.1.4.1.54321.1.4) # Packets In
    curl -s \"\$NTOPNG_URL/lua/rest/get/interface/stats\" | jq -r .pktRcvd
    ;;
  .1.3.6.1.4.1.54321.1.5) # Packets Out
    curl -s \"\$NTOPNG_URL/lua/rest/get/interface/stats\" | jq -r .pktSent
    ;;
  *) # Unknown OID
    echo \"No such object available on this agent at this OID\"
    exit 1
    ;;
esac
SCRIPT

# Create stats script
cat > /usr/local/bin/ntopng-snmp-stats << \"SCRIPT\"
#!/bin/bash
# SNMP pass-through script for SSSonector stats

OID=\"\$1\"
TYPE=\"\$2\"

case \"\$OID\" in
  .1.3.6.1.4.1.54321.2.1) # Tunnel Status
    systemctl is-active sssonector && echo 1 || echo 0
    ;;
  .1.3.6.1.4.1.54321.2.2) # Connected Clients
    netstat -an | grep :443 | grep ESTABLISHED | wc -l
    ;;
  .1.3.6.1.4.1.54321.2.3) # CPU Usage
    top -bn1 | grep \"Cpu(s)\" | awk \"{print \\\$2}\"
    ;;
  .1.3.6.1.4.1.54321.2.4) # Memory Usage
    free | grep Mem | awk \"{print \\\$3/\\\$2 * 100}\"
    ;;
  *) # Unknown OID
    echo \"No such object available on this agent at this OID\"
    exit 1
    ;;
esac
SCRIPT

# Make scripts executable
chmod +x /usr/local/bin/ntopng-snmp
chmod +x /usr/local/bin/ntopng-snmp-stats

# Install jq for JSON parsing
apt-get update && apt-get install -y jq

# Restart SNMP daemon
systemctl restart snmpd

# Test SNMP queries
echo === TESTING NTOPNG METRICS ===
snmpwalk -v2c -c public localhost .1.3.6.1.4.1.54321.1

echo === TESTING SSSONECTOR STATS ===
snmpwalk -v2c -c public localhost .1.3.6.1.4.1.54321.2
EOL'"

expect {
    "password:" {
        send "$password\r"
        exp_continue
    }
    "Do you want to continue?" {
        send "Y\r"
        exp_continue
    }
    timeout {
        puts "\n❌ Operation timed out"
        exit 1
    }
    eof {
        puts "\n✅ Operation complete"
        exit 0
    }
}
