#!/usr/bin/expect -f

# Load VM credentials from JSON file
set qa_env [exec cat qa_environment.json]
set qa_vms [exec echo $qa_env | jq -r ".qa_vms\[\]"]

# Test commands to verify automation setup
set test_commands {
    "whoami"
    "sudo whoami"
    "sudo ls -la /root"
    "sudo systemctl status sshd"
}

foreach vm $qa_vms {
    set name [exec echo $vm | jq -r ".name"]
    set ip [exec echo $vm | jq -r ".ip"]
    set username [exec echo $vm | jq -r ".username"]

    puts "\nVerifying automation setup on $name ($ip)..."

    # Try SSH connection with key
    spawn ssh -i ~/.ssh/qa_key $username@$ip

    expect {
        "continue connecting (yes/no" {
            send "yes\r"
            exp_continue
        }
        "password:" {
            puts "❌ SSH key authentication failed on $name"
            exit 1
        }
        "$" {
            puts "✅ SSH key authentication successful on $name"

            # Test each command
            foreach cmd $test_commands {
                send "$cmd\r"
                expect {
                    "password for" {
                        puts "❌ Passwordless sudo failed for command: $cmd"
                        exit 1
                    }
                    "$" {
                        puts "✅ Successfully executed: $cmd"
                    }
                }
            }

            send "exit\r"
        }
        timeout {
            puts "❌ Connection timed out for $name"
            exit 1
        }
    }
}

puts "\n✅ Automation setup verified on all VMs"
exit 0
