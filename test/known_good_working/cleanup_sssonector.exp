#!/usr/bin/expect -f

# Load VM credentials from JSON file
set qa_env [exec cat qa_environment.json]
set qa_vms [exec echo $qa_env | jq -r ".qa_vms\[\]"]

foreach vm $qa_vms {
    set name [exec echo $vm | jq -r ".name"]
    set ip [exec echo $vm | jq -r ".ip"]
    set username "sblanken"

    puts "\nCleaning up SSSonector on $name ($ip)..."

    # SSH into the VM and perform cleanup
    spawn ssh -i /home/sblanken/.ssh/qa_key $username@$ip

    expect {
        "continue connecting (yes/no" {
            send "yes\r"
            exp_continue
        }
        "$" {
            # Stop any running services
            send "sudo systemctl stop sssonector-server sssonector-client 2>/dev/null\r"
            expect "$"
            
            # Disable services
            send "sudo systemctl disable sssonector-server sssonector-client 2>/dev/null\r"
            expect "$"
            
            # Remove service files
            send "sudo rm -f /etc/systemd/system/sssonector-*.service\r"
            expect "$"
            
            # Reload systemd
            send "sudo systemctl daemon-reload\r"
            expect "$"
            
            # Remove configuration directories
            send "sudo rm -rf /etc/sssonector\r"
            expect "$"
            
            # Remove log files
            send "sudo rm -rf /var/log/sssonector\r"
            expect "$"
            
            # Remove any installed binaries
            send "sudo rm -f /usr/local/bin/sssonector*\r"
            expect "$"
            
            # Clean up network interfaces
            send "sudo ip link del tun0 2>/dev/null\r"
            expect "$"
            
            puts "✅ Cleanup completed on $name"
            send "exit\r"
        }
    }
    expect eof
}

puts "\n✅ SSSonector cleanup completed on all VMs"
exit 0
