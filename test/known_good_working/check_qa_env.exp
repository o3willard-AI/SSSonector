#!/usr/bin/expect -f

set timeout 30
set outfile [open "qa_environment_status.json" "w"]

puts $outfile "{\n  \"check_time\": \"[clock format [clock seconds] -format {%Y-%m-%d %H:%M:%S}]\","
puts $outfile "  \"vms\": {"

foreach ip {192.168.50.210 192.168.50.211 192.168.50.212} {
    puts "\nChecking VM $ip..."
    
    spawn ssh -i /home/sblanken/.ssh/qa_key sblanken@$ip
    
    expect {
        "continue connecting (yes/no" {
            send "yes\r"
            exp_continue
        }
        "$" {
            # Get hostname
            send "hostname\r"
            expect -re "(\[^\r\n]+)\r\n"
            set hostname $expect_out(1,string)
            expect "$"
            
            # Get system info
            send "df -h / | tail -1 | awk '{print \$5}'\r"
            expect -re "(\[0-9\]+)%"
            set disk_usage $expect_out(1,string)
            expect "$"
            
            send "free -m | grep Mem | awk '{print int(\$3/\$2 * 100)}'\r"
            expect -re "(\[0-9\]+)"
            set mem_usage $expect_out(1,string)
            expect "$"
            
            # Check running services
            send "systemctl is-active ntopng snmpd 2>/dev/null || echo inactive\r"
            expect -re "(\[^\r\n]+)\r\n"
            set services_status $expect_out(1,string)
            expect "$"
            
            # Check network interface
            send "ip addr show enp0s3 | grep inet | head -1 | awk '{print \$2}'\r"
            expect -re "(\[^\r\n]+)\r\n"
            set ip_addr $expect_out(1,string)
            expect "$"
            
            # Write status to JSON
            puts $outfile "    \"$ip\": {"
            puts $outfile "      \"hostname\": \"$hostname\","
            puts $outfile "      \"disk_usage_percent\": $disk_usage,"
            puts $outfile "      \"memory_usage_percent\": $mem_usage,"
            puts $outfile "      \"services\": \"$services_status\","
            puts $outfile "      \"ip_address\": \"$ip_addr\""
            puts $outfile "    }[expr {$ip == "192.168.50.212" ? "" : ","}]"
            
            send "exit\r"
        }
        timeout {
            puts $outfile "    \"$ip\": {"
            puts $outfile "      \"status\": \"timeout\""
            puts $outfile "    }[expr {$ip == "192.168.50.212" ? "" : ","}]"
        }
        eof {
            puts $outfile "    \"$ip\": {"
            puts $outfile "      \"status\": \"connection failed\""
            puts $outfile "    }[expr {$ip == "192.168.50.212" ? "" : ","}]"
        }
    }
    expect eof
}

puts $outfile "  }\n}"
close $outfile

puts "\nâœ… QA environment status saved to qa_environment_status.json"
exit 0
