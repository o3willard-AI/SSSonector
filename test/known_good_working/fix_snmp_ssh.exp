#!/usr/bin/expect -f

set username "sblanken"
set password "101abn"
set ip "192.168.50.212"

puts "\nFixing SSH key authentication for SNMP Server..."

# First try to create .ssh directory and set permissions
spawn ssh -o PreferredAuthentications=password -o PubkeyAuthentication=no $username@$ip "mkdir -p ~/.ssh && chmod 700 ~/.ssh"
expect {
    "password:" {
        send "$password\r"
        expect eof
    }
}

# Copy SSH key
spawn ssh-copy-id -i /home/sblanken/.ssh/qa_key $username@$ip
expect {
    "continue connecting (yes/no" {
        send "yes\r"
        exp_continue
    }
    "password:" {
        send "$password\r"
        expect eof
    }
}

# Verify SSH key access
spawn ssh -i /home/sblanken/.ssh/qa_key $username@$ip "echo 'SSH key authentication successful'"
expect {
    "continue connecting (yes/no" {
        send "yes\r"
        exp_continue
    }
    "SSH key authentication successful" {
        puts "✅ Successfully configured SSH key authentication"
        exit 0
    }
    timeout {
        puts "❌ Failed to verify SSH key authentication"
        exit 1
    }
}
